// ======================
//  GENERATOR & DB
// ======================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
//  ENUMS
// ======================
enum ProjectStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  DELETED // ðŸ§  helpful for filtering in UI
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  DELETED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  PARTIALLY_PAID
  DELETED
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  FOREMAN
  WORKER
  CONTRACTOR
}

enum ClientType {
  RESIDENTIAL
  COMMERCIAL
  OTHER
}

enum AddressType {
  BUSINESS
  SITE
  CLIENT_BUSINESS
  CLIENT_SITE
  OTHER
}

// ======================
//  REGION (FOR TAX & LANGUAGE)
// ======================
model Region {
  id             String  @id @default(cuid())
  code           String  @unique
  name           String
  currencyCode   String
  currencySymbol String
  taxLabel       String
  defaultTaxRate Decimal @db.Decimal(5, 2)
  locale         String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  businesses Business[]

  @@index([code])
}

// ======================
//  ADDRESS
// ======================
model Address {
  id          String      @id @default(cuid())
  addressType AddressType @default(BUSINESS)

  line1       String
  line2       String?
  city        String
  state       String?
  postcode    String
  country     String?
  countryCode String?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  businesses Business[] @relation("BusinessAddresses")
  clients    Client[]   @relation("ClientAddresses")
}

// ======================
//  BUSINESS (TENANT)
// ======================
model Business {
  id                 String  @id @default(cuid())
  name               String
  legalName          String?
  registrationNumber String?
  email              String
  phone              String?
  website            String?
  logoUrl            String?

  regionId String
  region   Region @relation(fields: [regionId], references: [id])

  addressId String?
  address   Address? @relation(fields: [addressId], references: [id], name: "BusinessAddresses")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  users           User[]
  clients         Client[]
  projects        Project[]
  quotes          Quote[]
  invoices        Invoice[]
  billableItems   BillableItem[]
  invoiceSettings InvoiceSettings?
  tasks           Task[]
  projectExpenses ProjectExpense[]
  timeLogs        TimeLog[]
  payments        Payment[]

  @@index([regionId])
}

// ======================
//  USERS / EMPLOYEES
// ======================
model User {
  id String @id @default(cuid())

  businessId String?
  business   Business? @relation(fields: [businessId], references: [id])

  email      String   @unique
  password   String
  name       String
  role       UserRole @default(WORKER)
  phone      String?
  hourlyRate Decimal? @db.Decimal(10, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  tasks           Task[]
  timeLogs        TimeLog[]
  managedProjects Project[] @relation("ProjectManager")

  @@index([businessId])
}

// ======================
//  CLIENT
// ======================
model Client {
  id           String     @id @default(cuid())
  firstName    String
  lastName     String
  businessName String?
  phone        String?
  email        String?
  type         ClientType @default(RESIDENTIAL)

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  addresses Address[] @relation("ClientAddresses")
  projects  Project[]
  invoices  Invoice[]
  payments  Payment[] // ðŸ”¥ NEW â€” Opposite side of Payment.client
  notes     String?   @db.Text
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([businessId])
}

// ======================
//  PROJECT
// ======================
model Project {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  title          String
  description    String?
  location       String?
  status         ProjectStatus @default(PENDING)
  startDate      DateTime?
  endDate        DateTime?
  budgetedAmount Decimal?      @db.Decimal(10, 2)

  managerId String?
  manager   User?   @relation("ProjectManager", fields: [managerId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  quotes   Quote[]
  invoices Invoice[]
  tasks    Task[]
  expenses ProjectExpense[]
  timeLogs TimeLog[]

  @@index([businessId])
  @@index([clientId])
  @@index([managerId])
  @@index([status])
}

// ======================
//  QUOTE
// ======================
model Quote {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  quoteNumber String      @unique
  status      QuoteStatus @default(DRAFT)
  issueDate   DateTime    @default(now())
  expiryDate  DateTime?

  subtotal    Decimal @db.Decimal(10, 2)
  taxRate     Decimal @default(0.00) @db.Decimal(5, 2)
  taxAmount   Decimal @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  items QuoteItem[]

  @@index([businessId])
  @@index([projectId])
  @@index([status])
}

// Quote Item (NO CHANGE)
model QuoteItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
}

// ======================
//  BILLABLE ITEM (PRICE BOOK)
// ======================
model BillableItem {
  id          String    @id @default(cuid())
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id])
  name        String    @unique
  description String?
  unitPrice   Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([businessId])
}

// ======================
//  INVOICE SETTINGS
// ======================

model InvoiceSettings {
  id         String   @id @default(cuid())
  businessId String   @unique
  business   Business @relation(fields: [businessId], references: [id])

  businessName    String?
  abn             String?
  addressSnapshot Json?
  phone           String?
  email           String?
  website         String?
  logoUrl         String?
  bankDetails     String?

  invoicePrefix  String? @default("INV-")
  startingNumber Int?    @default(1000)
  defaultDueDays Int?    @default(14)
  taxRate        Decimal @default(0.10) @db.Decimal(5, 2)
  taxLabel       String?

  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPassword String?
  fromEmail    String?
  fromName     String?

  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ======================
//  INVOICE 
// ======================
model Invoice {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  invoiceNumber   String @unique
  invoicePrefix   String
  invoiceSequence Int

  status    InvoiceStatus @default(DRAFT)
  issueDate DateTime      @default(now())
  dueDate   DateTime
  notes     String?

  taxRate          Decimal @default(0.00) @db.Decimal(5, 2)
  taxLabelSnapshot String
  subtotal         Decimal @db.Decimal(10, 2)
  taxAmount        Decimal @db.Decimal(10, 2)
  totalAmount      Decimal @db.Decimal(10, 2)
  currencyCode     String

  businessSnapshot Json
  clientSnapshot   Json

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  items    InvoiceItem[]
  payments Payment[]

  @@index([businessId])
  @@index([projectId])
  @@index([clientId])
  @@index([status])
}

// ======================
//  INVOICE ITEM
// ======================
model InvoiceItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// ======================
//  PAYMENTS
// ======================
model Payment {
  id String @id @default(cuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  // NEW â€” supports reporting by client!
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  amount Decimal  @db.Decimal(10, 2)
  date   DateTime @default(now())
  method String
  notes  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([businessId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([date])
}

// ======================
//  TASKS, EXPENSES, TIME LOGS
// ======================

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  isCompleted Boolean   @default(false)
  dueDate     DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  @@index([projectId])
  @@index([assignedToId])
}

model ProjectExpense {
  id          String   @id @default(cuid())
  description String
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @default(now())
  category    String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([date])
}

model TimeLog {
  id          String   @id @default(cuid())
  date        DateTime
  hoursWorked Decimal  @db.Decimal(5, 2)
  notes       String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([projectId])
  @@index([userId])
  @@index([date])
}
